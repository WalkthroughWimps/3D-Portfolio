/* Body Styling */
body {
    --dark-color: var(--green-dark);
    --primary-color: var(--green-primary);
    --secondary-color: var(--green-secondary);
    --tertiary-color: var(--green-tertiary);
    --text-color: var(--green-text-color);
    --grey-color: var(--green-grey);
    --hl-primary-color: var(--red-primary);
    --hl-secondary-color: var(--red-secondary);
    --hl-tertiary-color: var(--red-tertiary);
    --hl-dark-color: var(--red-dark);
    --hl-text-color: var(--red-text-color);
    --controls-bg: var(--primary-color);
    --controls-fg: var(--hl-primary-color);
    background-image: url("assets/overlays/overlay-music-dark.png");
    background-repeat: repeat;    
    overflow-y: hidden;
}

/* Page background overlay (music page only; base pattern comes from template.css) */
.content {
    inline-size: 100vw;

    /* Start just below the fixed header */
    margin: calc(10rem + 1.5rem) 0 0;

    /* Take up the remaining viewport height */
    min-height: calc(100vh - (10rem + 1.5rem));

    padding: 0;

    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;

    background: none;
    box-shadow: none;
}



/* Keyframes for horizontal movement */
@keyframes moveRight {
    0% {
    transform: translateX(var(--xPos, 0px)) translateY(calc(var(--baseY) + var(--yOffset, 0px) + 0px)) scale(var(--scale-factor)) rotate(0deg);
    }
    25% {
    transform: translateX(var(--xPos, 0px)) translateY(calc(var(--baseY) + var(--yOffset, 0px) - 6px)) scale(var(--scale-factor)) rotate(var(--wiggle-angle));
    }
    50% {
    transform: translateX(var(--xPos, 0px)) translateY(calc(var(--baseY) + var(--yOffset, 0px) + 0px)) scale(var(--scale-factor)) rotate(calc(var(--wiggle-angle) * -1));
    }
    75% {
    transform: translateX(var(--xPos, 0px)) translateY(calc(var(--baseY) + var(--yOffset, 0px) + 6px)) scale(var(--scale-factor)) rotate(var(--wiggle-angle));
    }
    100% {
    transform: translateX(var(--xPos, 0px)) translateY(calc(var(--baseY) + var(--yOffset, 0px) + 0px)) scale(var(--scale-factor)) rotate(0deg);
    }
}

:root {
    --note-offset: 1s; /* Delay between note starts */
    --scale-factor: 1.1; /* Base scale factor (overridden per note) */
    --startX: -90px; /* Start further left */
    --stopX: 90px;  /* End further right */
    --wiggle-angle: 6deg; /* Wiggle amount */
    --baseY: -46px; /* Lift notes into the middle of the circle */
}

/* Horizontal animation already defined above as moveRight */

/* Class for notes */
.note {
    animation-name: moveRight;
    animation-timing-function: cubic-bezier(0.6, 0.2, 0.1, 1);
    animation-iteration-count: infinite;
    animation-fill-mode: forwards;
    animation-duration: 9.5s; /* default, overridden below */
    transform-origin: center center;
    transform-box: fill-box; /* Ensure SVG transforms behave predictably */
    opacity: 1;
    fill: var(--tertiary-color);
}

@media (prefers-reduced-motion: reduce) {
    .note {
        animation: none !important;
        opacity: 1;
    }
}

#clippath {
    fill: var(--green-secondary);
}

/* 3D piano preview area */
.piano-stage {
    max-width: 100;
    padding: 0;
}
.piano-canvas-wrap {
     /* Pin the canvas to the viewport below the fixed header so
         UI panels won't push the 3D canvas out of view.  The top offset
         uses a CSS variable set from JS to match the actual header height. */
    position: fixed;
    /* Align directly under the header's measured height to avoid clipping */
    top: var(--header-height, 10rem);
    left: 0;
    right: 0;
    bottom: 0;
    width: 100%;
    height: auto;
    overflow: hidden;
    z-index: 50; /* below overlay UI */
    display: block;
}
#pianoCanvas {
    width: 100%;
    height: 100%;
    display: block;
    z-index: 10;
    background: transparent;
}
.piano-play {
    position: absolute;
    top: 50%;
    right: 24px; /* Move button to right side of the content window */
    transform: translateY(-50%); /* Vertically center only */
    background: linear-gradient(180deg,var(--purple-secondary),var(--purple-primary));
    filter: brightness(1.5);
    color: #fff;
    border: none;
    padding: 0.8rem 1.2rem;
    border-radius: 999px;
    font: 600 18px/.5 "Source Sans 3", system-ui, -apple-system, Segoe UI, Roboto, Arial;
    letter-spacing: .02rem;
    box-shadow: 0 8px 18px rgba(126, 63, 224, 0.45);
    cursor: pointer;
}
.piano-play:hover { filter: brightness(2); }
.piano-play:active { transform: translateY(-50%) scale(0.98); }
.sync-offset-wrap {
    position:absolute;
    right:24px;
    top:calc(50% + 70px);
    width:220px;
    background:rgba(30,30,34,0.7);
    backdrop-filter: blur(4px);
    padding:10px 14px 12px;
    border-radius:12px;
    box-shadow:0 4px 12px rgba(0,0,0,0.35);
    font:500 12px/1.3 "Source Sans 3", system-ui;
    color:#cfd5e8;
}
/* New container for moved panels below header */
.music-info-panels {
    /* kept for legacy, not used when overlay is enabled */
    display:none;
}
.music-info-panels .piano-controls {
    display:flex;
    gap:8px;
    align-items:center;
    background:rgba(0,0,0,0.4);
    padding:6px 8px;
    border-radius:6px;
}
.music-info-panels .sync-offset-wrap { position:static; width:auto; }
/* Ensure panels sit above header and can overlap slightly to align with play button */
.music-ui-overlay {
    position:fixed;
    top: calc(10rem + 0.75rem);
    right: 16px;
    z-index: 1200;
    display:flex;
    gap:12px;
    align-items:center;
}
.instrument-picker {
    position: fixed;
    left: 0.75rem;
    /* push further down so it doesn't overlap the head graphic */
    top: calc(var(--header-height, 10rem) + 6rem);
    z-index: 1300; /* above .music-ui-overlay */
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    padding: 0.25rem;
    max-height: calc(100vh - (var(--header-height, 10rem) + 7rem));
    overflow: auto;
    pointer-events: auto;
    transition: transform 0.12s ease, box-shadow .12s ease;
    box-shadow: 0 6px 20px rgba(0,0,0,0.45);
    border-radius: 8px;
    backdrop-filter: blur(6px);
}

.instrument-picker--backboard {
    left: 0;
    top: 0;
    max-height: none;
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    gap: 0.4rem;
    padding: 0.5rem 0.75rem;
    background: rgba(0,0,0,0.55);
    backdrop-filter: blur(4px);
    border-radius: 10px;
    display: none; /* hidden in DOM; rendered on backboard */
}
.instrument-picker button {
    background: rgba(255,255,255,0.06);
    color: var(--fg, #fff);
    border: 1px solid rgba(255,255,255,0.06);
    padding: 0.4rem 0.6rem;
    font-size: 0.85rem;
    cursor: pointer;
    border-radius: 4px;
}
.instrument-picker button:hover{
    transform: translateY(-2px);
    filter: brightness(1.25);
}
.instrument-picker button:active{
    transform: translateY(0) scale(.98);
}
.instrument-picker button.active {
    background: #ff8c00; /* orange */
    color: #000;
    box-shadow: 0 4px 10px rgba(0,0,0,0.45);
}
.instrument-picker button.loading { opacity: 0.6; }
.music-ui-overlay .piano-controls {
    display:flex;
    gap:8px;
    align-items:center;
    background:rgba(0,0,0,0.4);
    padding:6px 8px;
    border-radius:6px;
}
.music-ui-overlay .sync-offset-wrap { width:220px; }
.music-ui-overlay .piano-play { position:relative; z-index:1300; }
.instrument-level-panel {
    position: fixed;
    right: 16px;
    top: calc(var(--header-height, 10rem) + 3.5rem);
    z-index: 1200;
    display: flex;
    gap: 12px;
    align-items: flex-start;
    padding: 10px 12px;
    background: rgba(0,0,0,0.45);
    border-radius: 10px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.45);
    color: #e8fff4;
    font: 12px/1.3 "Source Sans 3", system-ui;
}
.instrument-level-controls {
    display: flex;
    flex-direction: column;
    gap: 10px;
    min-width: 220px;
}
.instrument-level-row {
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.instrument-level-label-row {
    display: flex;
    align-items: center;
    gap: 6px;
    justify-content: space-between;
}
.instrument-level-row input[type="range"] {
    width: 220px;
    accent-color: #7dd3c7;
}
.instrument-level-row select {
    background: rgba(255,255,255,0.08);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 6px;
    padding: 2px 6px;
    font: 11px/1.2 "Source Sans 3", system-ui;
}
.instrument-level-row button {
    background: rgba(255,255,255,0.12);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.16);
    border-radius: 6px;
    padding: 6px 10px;
    cursor: pointer;
    font: 600 11px/1.2 "Source Sans 3", system-ui;
}
.instrument-level-row button:hover{
    filter: brightness(1.1);
}
.instrument-level-row button:disabled{
    opacity: 0.6;
    cursor: default;
}
.instrument-level-target {
    font-size: 11px;
    opacity: 0.8;
}
.instrument-level-readout {
    font-size: 11px;
    opacity: 0.85;
}
.instrument-level-effective {
    font-size: 12px;
    opacity: 0.9;
    padding-top: 2px;
}
.visualizer-container { width: 150px; height: 480px; display:flex; flex-direction:column; align-items:flex-start; justify-content:center; gap:8px; }
.viz-meter { display:flex; align-items:stretch; gap:6px; }
.viz-scale { display:flex; flex-direction:column; justify-content:space-between; height:420px; font-size:11px; opacity:.75; }
.viz-mark { display:flex; align-items:center; gap:6px; }
.viz-rule { width:18px; height:1px; background:rgba(255,255,255,.25); }
canvas#instrumentVisualizer { width:28px; height:420px; background:transparent; display:block; }
.viz-readout { font-size:12px; opacity:.85; }
.sync-label { display:flex; flex-direction:column; gap:4px; font-weight:600; font-size:12px; }
#syncOffset { width:100%; accent-color:#7b3fe0; }
.sync-value { font-weight:600; font-size:12px; color:#fff; }
.sync-hint { display:block; margin-top:6px; font-size:11px; opacity:0.6; }
@media (max-width: 800px){
    .sync-offset-wrap { position:static; margin:8px auto 0; top:auto; right:auto; transform:none; }
    .piano-play { right:50%; transform:translate(50%, -50%); }
    .instrument-level-panel {
        position: static;
        margin: 12px auto 0;
        width: min(95vw, 520px);
        flex-wrap: wrap;
        justify-content: center;
    }
}
.piano-notes { margin-top: 0.5rem; color: #c9c9d4; font: 500 12px/1.4 "Source Sans 3", system-ui; text-align: center; }
